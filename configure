#!/bin/sh

if test -z "$CMAKE"; then CMAKE="`which cmake`"; fi
if test -z "$CMAKE"; then CMAKE=/Applications/CMake.app/Contents/bin/cmake; fi
if ! test -f "$CMAKE"; then echo "no ‘cmake’ command found"; exit 1; fi

: ${R_HOME:=$(R RHOME)}
if test -z "${R_HOME}"; then
  echo "could not determine R_HOME"
  exit 1
fi
RCC=`"${R_HOME}/bin/R" CMD config CC`
CC=${RCC%% *}
RCC=${RCC#$CC}
EXTRACFLAGS=$(echo "$RCC"| sed -e  "s/-std=[^ ]\{0,\}//")
RCXX=`"${R_HOME}/bin/R" CMD config CXX`
CXX=${RCXX%% *}
RCXX=${RCXX#$CXX}
EXTRACXXFLAGS=$(echo "$RCXX"| sed -e  "s/-std=[^ ]\{0,\}//")
CFLAGS=`"${R_HOME}/bin/R" CMD config CFLAGS`
CPPFLAGS=`"${R_HOME}/bin/R" CMD config CPPFLAGS`
CXXFLAGS=`"${R_HOME}/bin/R" CMD config CXXFLAGS`
R_LDFLAGS=`"${R_HOME}/bin/R" CMD config LDFLAGS`
R_SHLDFLAGS=`"${R_HOME}/bin/R" CMD config SHLIB_LDFLAGS`
FC=`"${R_HOME}/bin/R" CMD config FC`
FLIBS=`"${R_HOME}/bin/R" CMD config FLIBS`
R_SHLIB_EXT=`"${R_HOME}/bin/R" CMD config SHLIB_EXT`

CFLAGS="$CPPFLAGS $CFLAGS $EXTRACFLAGS"
CXXFLAGS="$CPPFLAGS $CXXFLAGS $EXTRACXXFLAGS"
#LDFLAGS="$R_LDFLAGS $R_SHLDFLAGS"

cd src

# Apply patch to planc CMakeLists.txt for ZLIB and macOS support
if [ -f "planc/CMakeLists.txt" ] && [ -f "../tools/patches/04_add_zlib_macos_support.patch" ]; then
  # Check if patch has already been applied
  if ! grep -q "find_package(ZLIB REQUIRED)" planc/CMakeLists.txt; then
    echo "Applying ZLIB and macOS support patch to planc/CMakeLists.txt..."
    patch -p1 -d planc < ../tools/patches/04_add_zlib_macos_support.patch || echo "Warning: patch may already be applied"
  fi
fi

mkdir -p build && cd build

# Detect platform and set up Homebrew paths for macOS
CMAKE_PREFIX_PATH=""
if [ "$(uname -s)" = "Darwin" ]; then
  ARCH="$(uname -m)"
  if [ "$ARCH" = "arm64" ]; then
    # Apple Silicon - Homebrew installs to /opt/homebrew
    CMAKE_PREFIX_PATH="/opt/homebrew"
  else
    # Intel Mac - Homebrew installs to /usr/local
    CMAKE_PREFIX_PATH="/usr/local"
  fi

  # If HDF5_ROOT is set, add it to CMAKE_PREFIX_PATH
  if [ -n "$HDF5_ROOT" ]; then
    CMAKE_PREFIX_PATH="${HDF5_ROOT};${CMAKE_PREFIX_PATH}"
  fi
fi

# Build CMAKE_ARGS with prefix path if needed
if [ -n "$CMAKE_PREFIX_PATH" ]; then
  CMAKE_ARGS="${CMAKE_ARGS} -DCMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH}"
fi

$CMAKE -S ../planc \
  -DCMAKE_EXPORT_COMPILE_COMMANDS=TRUE \
  -DCMAKE_BUILD_TYPE=RelWithDebInfo \
  -DCMAKE_POSITION_INDEPENDENT_CODE:bool=ON \
  -DCMAKE_C_COMPILER="$CC" \
  -DCMAKE_CXX_COMPILER="$CXX" \
  -DPASSTHROUGH_CONFIGURE_ARGS="$*" \
  -DBUILD_RCPP=ON \
  -DR_SHLIB_EXT="$R_SHLIB_EXT" \
  -DR_RHOME="$R_HOME" \
  -DBUILD_SHARED_LIBS=OFF \
  -DCMAKE_INSTALL_PREFIX=$R_PACKAGE_DIR \
  -DCMAKE_OSX_DEPLOYMENT_TARGET="11" \
  ${CMAKE_ARGS}

# Only touch files if they exist (avoid errors with non-existent paths)
if [ -f "_deps/highfive-src/include/highfive/bits/H5Friends.hpp" ]; then
  echo "" >>  _deps/highfive-src/include/highfive/bits/H5Friends.hpp
fi

${MAKE}
$CMAKE --install .

# Copy config.h to src/ directory so R can find it
# R's build system may not properly use our Makevars file, so ensure config.h
# is in a location that can be found with #include "config.h"
echo "Searching for config.h..."
find . -name "config.h" -type f

if [ -f "nmf/config.h" ]; then
  cp nmf/config.h ../config.h
  echo "Copied config.h from build/nmf/ to src/"
elif [ -f "../planc/common/config.h" ]; then
  cp ../planc/common/config.h ../config.h
  echo "Copied config.h from planc/common/ to src/"
elif [ -f "_deps/planc-src/common/config.h" ]; then
  cp _deps/planc-src/common/config.h ../config.h
  echo "Copied config.h from _deps/ to src/"
else
  echo "ERROR: config.h not found in expected locations"
  echo "Creating a minimal config.h as fallback..."
  cat > ../config.h << 'EOF'
#ifndef PLANC_CONFIG_H
#define PLANC_CONFIG_H
#define USING_R 1
#endif
EOF
fi

# Verify Makevars was generated by CMake's file(GENERATE) command
# Do NOT overwrite it - file(GENERATE) properly expands generator expressions
if [ -f "../Makevars" ]; then
  echo "Makevars generated successfully by CMake"
  echo "Contents of Makevars:"
  cat ../Makevars
  echo "---End of Makevars---"
  # Verify content
  if grep -q "PKG_CPPFLAGS.*-Iplanc/common" ../Makevars; then
    echo "Makevars contains expected include paths"
  else
    echo "WARNING: Makevars may be incomplete - missing expected include paths"
  fi
elif [ -f "../Makevars.gen" ]; then
  # Fallback: if file(GENERATE) didn't create Makevars, use Makevars.gen
  echo "Warning: Using Makevars.gen as fallback"
  cp ../Makevars.gen ../Makevars
else
  echo "ERROR: No Makevars file found - build may fail"
fi

# Rename Makevars.in to prevent R from processing it
# Only do this if Makevars was successfully created
if [ -f "../Makevars" ] && [ -f "../Makevars.in" ]; then
  mv ../Makevars.in ../Makevars.in.bak
  echo "Renamed Makevars.in to prevent conflicts"
fi

# Only touch cmake test file if its directory exists
if [ -d "CMakeFiles/hdf5" ] && [ -f "CMakeFiles/hdf5/cmake_hdf5_test.c" ]; then
  echo "" >>  CMakeFiles/hdf5/cmake_hdf5_test.c
fi
